# FreeRADIUS Syslog(SystemEvents) 기반 사용자-단말(MAC)-VLAN-IP 바인딩 자동화

> **목표**  
> FreeRADIUS 인증 성공 로그(`Login OK`)와 DHCP 할당 로그(`DHCPACK`)가 `SystemEvents`(syslog DB)로 들어올 때,  
> 문자열 파싱을 통해 **사용자 계정(User-Name)** 과 **단말 MAC** 을 추출하고,  
> `radusergroup` → VLAN 프로필 매핑으로 **VLAN ID**를 결정한 뒤  
> `endpoint_identity_binding` 테이블에 **실명제 바인딩(사용자↔MAC↔VLAN↔IP)** 을 자동 갱신한다.

---

## 1. 입력 데이터: FreeRADIUS 인증 성공 로그(Login OK)

이번 자동화는 **아래 형태의 사용자 계정기반 Login OK 로그만** 대상으로 한다.

- `Login OK: [<username>/<via ...>]`
- `(from client <NAS> port <n> cli <MAC>)`

---

## 2. 파싱 전략(쉽고 덜 깨지는 방식)

정규식(`REGEXP`)을 과하게 복잡하게 만들면 로그 포맷이 조금만 바뀌어도 깨질 수 있어,  
**필수 토큰만 존재 여부로 필터링**하고, 추출은 `SUBSTRING_INDEX` 위주로 단순화한다.

### 2.1 “원하는 Login OK”만 필터링
아래 조건이 동시에 만족할 때만 파싱:

- `Login OK:` 포함
- `/<via ` 포함  → (원하는 인증 타입 구분)
- ` cli ` 포함   → (MAC이 실제로 포함된 케이스)
- `Auth-Type = EAP` 포함(선택) → 더 정확히 좁히고 싶을 때

예)
```sql
NEW.message LIKE 'Login OK:%'
AND INSTR(NEW.message, '/<via ') > 0
AND INSTR(NEW.message, ' cli ') > 0
AND INSTR(NEW.message, 'Auth-Type = EAP') > 0
```

### 2.2 username 추출
`Login OK: [55782/<via ...` 형태에서:

```sql
SET d_user_name = TRIM(SUBSTRING_INDEX(REPLACE(NEW.message, 'Login OK: [', ''), '/', 1));
```

### 2.3 MAC 추출
` cli f0:6b:...:65)` 에서:

```sql
SET d_mac_addr = LOWER(REPLACE(
  SUBSTRING_INDEX(SUBSTRING_INDEX(NEW.message, ' cli ', -1), ')', 1),
  '-', ':'
));
```

---

## 3. 핵심 테이블: endpoint_identity_binding

**사용자/단말/네트워크 식별을 한 테이블로 묶는 바인딩 테이블**이다.

- `user_name` : 사용자 계정
- `mac_addr`  : 단말 MAC(정규화된 소문자 `:` 표기)
- `vlan_id`   : 부서/그룹 기반 VLAN 식별자
- `ip_addr`   : DHCP로 할당받은 IP
- `ip_number` : `INET_ATON(ip_addr)` (정렬/검색 용)

테이블 생성 스크린샷:

<img width="961" height="557" alt="스크린샷 2026-02-11 125113" src="https://github.com/user-attachments/assets/5020dab3-5fac-42e2-ab5a-7dcd06095da0" />


예시 DDL(개념):
```sql
CREATE TABLE radius.endpoint_identity_binding (
  id        INT NOT NULL AUTO_INCREMENT,
  user_name VARCHAR(40) NOT NULL DEFAULT '',
  mac_addr  VARCHAR(40) NOT NULL DEFAULT '',
  vlan_id   SMALLINT UNSIGNED NOT NULL DEFAULT 0,
  ip_addr   VARCHAR(40) NOT NULL DEFAULT '',
  ip_number INT UNSIGNED NOT NULL DEFAULT 0,
  host_name VARCHAR(40) NOT NULL DEFAULT '',
  reg_type  VARCHAR(1)  NOT NULL DEFAULT 'A',
  PRIMARY KEY (id),

  -- (선택) 중복 방지: 조합 유니크
  CONSTRAINT uq_binding UNIQUE (user_name, mac_addr, vlan_id, ip_addr)
);
```

---

## 4. 트리거 #1: SystemEvents → (Login OK + DHCPACK) 파싱

### 4.1 ai_systemevents_login_ok_and_dhcp_ack (AFTER INSERT ON SystemEvents)

역할:
- **Login OK(원하는 패턴)** 인 경우
  1) `user_name`, `mac_addr` 추출
  2) `radusergroup` ↔ `vlan_network_profiles` 매핑으로 `vlan_id` 결정
  3) `endpoint_identity_binding`에 `(user_name, mac_addr, vlan_id)`가 없으면 INSERT
- **DHCPACK** 인 경우
  - `ip_addr`, `mac_addr`, `host_name`, `vlan_id` 등을 파싱해 `dhcp_log`에 INSERT

트리거 생성 과정(성공):

<img width="949" height="522" alt="03_trigger_create_success" src="https://github.com/user-attachments/assets/5e8f56f1-e8c0-420b-90c6-28b2917bbe2c" />


---

## 5. 트리거 #2: dhcp_log INSERT 시 → endpoint_identity_binding IP 갱신

### 5.1 ai_dhcp_log (AFTER INSERT ON dhcp_log)

역할:
- dhcp_log에 `mac_addr`, `vlan_id` 조합으로 **정확히 1개의 바인딩 레코드**가 있고
- 그 레코드의 `ip_number`가 0(미할당) 상태면
  - `endpoint_identity_binding.ip_addr` 및 `ip_number`를 업데이트
  - `subnet_ip_pool`에도 해당 IP의 `mac_addr`, `user_name`을 업데이트

트리거 생성 스크린샷:

<img width="956" height="274" alt="04_trigger_create_ai_dhcp_log" src="https://github.com/user-attachments/assets/fd2b1f30-8d7b-42b5-9838-8a30ef18cc5b" />


---

## 6. 트리거 #3: endpoint_identity_binding DELETE 시 → subnet_ip_pool 정리

### 6.1 ad_endpoint_identify_binding (AFTER DELETE ON endpoint_identity_binding)

역할:
- 바인딩 레코드가 삭제되면(퇴직/계정 회수 등)
  - `subnet_ip_pool`에서 해당 `ip_number`의 `user_name`, `mac_addr`를 공백으로 정리

트리거 생성 스크린샷:

<img width="908" height="423" alt="05_trigger_create_ad_endpoint_delete" src="https://github.com/user-attachments/assets/3cc34f69-628a-42b3-b4dc-7802afb98382" />


---

